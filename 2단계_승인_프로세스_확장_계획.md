# 2ë‹¨ê³„ ìŠ¹ì¸ í”„ë¡œì„¸ìŠ¤ í™•ì¥ ê³„íš

## ğŸ“‹ ê°œìš”

í˜„ì¬ëŠ” ë‹¨ì¼ ìŠ¹ì¸ í”„ë¡œì„¸ìŠ¤ë¡œ êµ¬í˜„ë˜ì–´ ìˆìœ¼ë‚˜, í–¥í›„ ë‹¤ìŒê³¼ ê°™ì€ 2ë‹¨ê³„ ìŠ¹ì¸ í”„ë¡œì„¸ìŠ¤ë¡œ í™•ì¥í•  ì˜ˆì •ì…ë‹ˆë‹¤:

1. **1ë‹¨ê³„: ë‹´ë‹¹ì ìŠ¹ì¸** (Manager Approval)
2. **2ë‹¨ê³„: ë°©ë¬¸ ë¶€ì„œì˜ ìŠ¹ì¸ì ìŠ¹ì¸** (Department Approver Approval) â†’ ìµœì¢… ìŠ¹ì¸ ì‹œ QR ì½”ë“œ ìƒì„± ë° SMS ë°œì†¡

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ í™•ì¥

### 1. `visit_requests` í…Œì´ë¸”ì— ì¶”ê°€í•  í•„ë“œ

```sql
-- ë‹´ë‹¹ì ê´€ë ¨ í•„ë“œ
manager_id UUID REFERENCES managers(id),  -- ë‹´ë‹¹ì ID
manager_department TEXT,                   -- ë‹´ë‹¹ì ë¶€ì„œ
visiting_department TEXT,                  -- ë°©ë¬¸ ë¶€ì„œ

-- ìŠ¹ì¸ì ê´€ë ¨ í•„ë“œ
department_approver_id UUID REFERENCES managers(id),  -- ë°©ë¬¸ ë¶€ì„œ ìŠ¹ì¸ì ID

-- ìŠ¹ì¸ ë‹¨ê³„ë³„ íƒ€ì„ìŠ¤íƒ¬í”„
manager_approved_at TIMESTAMPTZ,           -- ë‹´ë‹¹ì ìŠ¹ì¸ ì‹œê°„
department_approver_approved_at TIMESTAMPTZ,  -- ë¶€ì„œ ìŠ¹ì¸ì ìŠ¹ì¸ ì‹œê°„
```

### 2. `visit_status` enum í™•ì¥

```sql
-- í˜„ì¬ ìƒíƒœ
-- REQUESTED, APPROVED, REJECTED, COMPLETED, CANCELLED

-- ì¶”ê°€í•  ìƒíƒœ
ALTER TYPE visit_status ADD VALUE 'MANAGER_APPROVED';      -- ë‹´ë‹¹ì ìŠ¹ì¸ ì™„ë£Œ
ALTER TYPE visit_status ADD VALUE 'DEPARTMENT_APPROVED';    -- ë¶€ì„œ ìŠ¹ì¸ì ìŠ¹ì¸ ì™„ë£Œ (ìµœì¢… ìŠ¹ì¸)
```

ë˜ëŠ” ìƒˆë¡œìš´ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ë¡œ:

```sql
-- supabase/migrations/002_two_stage_approval.sql

-- visit_status enum í™•ì¥
DO $$ BEGIN
  ALTER TYPE visit_status ADD VALUE IF NOT EXISTS 'MANAGER_APPROVED';
  ALTER TYPE visit_status ADD VALUE IF NOT EXISTS 'DEPARTMENT_APPROVED';
EXCEPTION
  WHEN duplicate_object THEN null;
END $$;

-- visit_requests í…Œì´ë¸”ì— í•„ë“œ ì¶”ê°€
ALTER TABLE visit_requests
  ADD COLUMN IF NOT EXISTS manager_id UUID REFERENCES managers(id),
  ADD COLUMN IF NOT EXISTS manager_department TEXT,
  ADD COLUMN IF NOT EXISTS visiting_department TEXT,
  ADD COLUMN IF NOT EXISTS department_approver_id UUID REFERENCES managers(id),
  ADD COLUMN IF NOT EXISTS manager_approved_at TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS department_approver_approved_at TIMESTAMPTZ;

-- ì¸ë±ìŠ¤ ì¶”ê°€ (ì„±ëŠ¥ ìµœì í™”)
CREATE INDEX IF NOT EXISTS idx_visit_requests_manager_id 
  ON visit_requests(manager_id);
CREATE INDEX IF NOT EXISTS idx_visit_requests_department_approver_id 
  ON visit_requests(department_approver_id);
CREATE INDEX IF NOT EXISTS idx_visit_requests_status 
  ON visit_requests(status);
```

### 3. `managers` í…Œì´ë¸” í™•ì¥ (ë˜ëŠ” ìƒˆ í…Œì´ë¸”)

```sql
-- managers í…Œì´ë¸”ì— ì¶”ê°€í•  í•„ë“œ
ALTER TABLE managers
  ADD COLUMN IF NOT EXISTS is_approver BOOLEAN DEFAULT false,  -- ìŠ¹ì¸ì ì—¬ë¶€
  ADD COLUMN IF NOT EXISTS approver_level TEXT,               -- ìŠ¹ì¸ ë ˆë²¨: 'manager' | 'department_approver'
  ADD COLUMN IF NOT EXISTS department TEXT;                   -- ë¶€ì„œëª…

-- ë˜ëŠ” ë³„ë„ í…Œì´ë¸” ìƒì„±
CREATE TABLE IF NOT EXISTS department_approvers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  manager_id UUID REFERENCES managers(id) NOT NULL,
  department TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(manager_id, department)
);
```

## ğŸ”„ ìŠ¹ì¸ í”„ë¡œì„¸ìŠ¤ íë¦„

```
1. ë°©ë¬¸ ì‹ ì²­ (REQUESTED)
   â†“
2. ë‹´ë‹¹ì ìŠ¹ì¸ (MANAGER_APPROVED)
   - ë‹´ë‹¹ìê°€ ìŠ¹ì¸
   - manager_approved_at ì—…ë°ì´íŠ¸
   - status = 'MANAGER_APPROVED'
   â†“
3. ë°©ë¬¸ ë¶€ì„œ ìŠ¹ì¸ì ìŠ¹ì¸ (DEPARTMENT_APPROVED = ìµœì¢… ìŠ¹ì¸)
   - ë°©ë¬¸ ë¶€ì„œì˜ ìŠ¹ì¸ìê°€ ìŠ¹ì¸
   - department_approver_approved_at ì—…ë°ì´íŠ¸
   - QR ì½”ë“œ ìƒì„±
   - ë¬¸ì ë©”ì‹œì§€ ë°œì†¡
   - status = 'APPROVED'
```

## ğŸ’» ì½”ë“œ ìˆ˜ì • ì‚¬í•­

### 1. API í•¨ìˆ˜ ìˆ˜ì • (`src/lib/api.ts`)

```typescript
// ë‹´ë‹¹ì ìŠ¹ì¸ í•¨ìˆ˜
export async function approveByManager(
  id: string, 
  managerId: string
) {
  const { data, error } = await supabase
    .from("visit_requests")
    .update({
      status: "MANAGER_APPROVED",
      manager_id: managerId,
      manager_approved_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
    })
    .eq("id", id)
    .select()
    .single();

  if (error) throw error;
  return data;
}

// ë¶€ì„œ ìŠ¹ì¸ì ìŠ¹ì¸ í•¨ìˆ˜ (ìµœì¢… ìŠ¹ì¸)
export async function approveByDepartmentApprover(
  id: string, 
  approverId: string
) {
  // ë¨¼ì € ë°©ë¬¸ ìš”ì²­ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const { data: visitRequest, error: fetchError } = await supabase
    .from("visit_requests")
    .select(`
      *,
      visitor_info (*),
      checklists (*)
    `)
    .eq("id", id)
    .single();

  if (fetchError) throw fetchError;

  // QR ì½”ë“œ ë°ì´í„° ìƒì„±
  const qrCodeData = await generateQRCodeData(visitRequest);
  const qrCodeUrl = `/visit/checkin?code=${encodeURIComponent(qrCodeData)}`;

  // ìµœì¢… ìŠ¹ì¸ ì²˜ë¦¬ ë° QR ì½”ë“œ ì €ì¥
  const { data, error } = await supabase
    .from("visit_requests")
    .update({
      status: "APPROVED",
      department_approver_id: approverId,
      department_approver_approved_at: new Date().toISOString(),
      approved_by: approverId,
      approved_at: new Date().toISOString(),
      qr_code_data: qrCodeData,
      qr_code_url: qrCodeUrl,
      updated_at: new Date().toISOString(),
    })
    .eq("id", id)
    .select()
    .single();

  if (error) throw error;

  // SMS ë°œì†¡
  if (visitRequest.visitor_info && visitRequest.visitor_info.length > 0) {
    const phone = visitRequest.visitor_info[0].visitor_phone;
    const message = `[ê´‘ë™ì œì•½] ë°©ë¬¸ì˜ˆì•½ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ˆì•½ë²ˆí˜¸: ${visitRequest.reservation_number}. ë°©ë¬¸ì¼: ${format(new Date(visitRequest.visit_date), "yyyyë…„ Mì›” dì¼", { locale: ko })}. QR ì½”ë“œ: ${window.location.origin}${qrCodeUrl}`;
    
    try {
      await sendSMSNotification(id, phone, message);
    } catch (smsError) {
      console.error("ë¬¸ì ì „ì†¡ ì˜¤ë¥˜:", smsError);
      // ë¬¸ì ì „ì†¡ ì‹¤íŒ¨í•´ë„ ìŠ¹ì¸ì€ ì™„ë£Œ
    }
  }

  return data;
}
```

### 2. EmployeeDashboard í˜ì´ì§€ ìˆ˜ì •

```typescript
// ì—­í• ë³„ íƒ­ ì¶”ê°€
const [activeTab, setActiveTab] = useState<'all' | 'manager' | 'approver'>('all');

// ì—­í• ë³„ í•„í„°ë§
const getFilteredRequests = () => {
  let filtered = filteredRequests;
  
  if (activeTab === 'manager') {
    // ë‹´ë‹¹ì ìŠ¹ì¸ ëŒ€ê¸° (REQUESTED ìƒíƒœ)
    filtered = filtered.filter(r => r.status === 'REQUESTED');
  } else if (activeTab === 'approver') {
    // ë¶€ì„œ ìŠ¹ì¸ì ìŠ¹ì¸ ëŒ€ê¸° (MANAGER_APPROVED ìƒíƒœ)
    filtered = filtered.filter(r => r.status === 'MANAGER_APPROVED');
  }
  
  return filtered;
};
```

### 3. AdminApproval í˜ì´ì§€ ìˆ˜ì •

```typescript
// í˜„ì¬ ì‚¬ìš©ìì˜ ì—­í•  í™•ì¸
const { data: { user } } = await supabase.auth.getUser();
const userRole = await getUserRole(user.id); // 'manager' | 'department_approver' | 'admin'

// ì—­í• ì— ë”°ë¼ ìŠ¹ì¸ ë²„íŠ¼ í‘œì‹œ
{userRole === 'manager' && request.status === 'REQUESTED' && (
  <Button onClick={() => handleManagerApprove(request)}>
    ë‹´ë‹¹ì ìŠ¹ì¸
  </Button>
)}

{userRole === 'department_approver' && request.status === 'MANAGER_APPROVED' && (
  <Button onClick={() => handleDepartmentApproverApprove(request)}>
    ë¶€ì„œ ìŠ¹ì¸ (QR ìƒì„± + SMS ë°œì†¡)
  </Button>
)}
```

## ğŸ“ êµ¬í˜„ ë‹¨ê³„

### Phase 1: í˜„ì¬ (ë‹¨ì¼ ìŠ¹ì¸)
- âœ… ì„ì§ì›ëª¨ë“œ í˜ì´ì§€ ìƒì„±
- âœ… AdminApproval í˜ì´ì§€ ê°œì„ 
- âœ… URL íŒŒë¼ë¯¸í„°ë¡œ ì˜ˆì•½ ì„ íƒ ê¸°ëŠ¥

### Phase 2: DB ìŠ¤í‚¤ë§ˆ í™•ì¥
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„± (`002_two_stage_approval.sql`)
- [ ] `visit_status` enum í™•ì¥
- [ ] `visit_requests` í…Œì´ë¸”ì— í•„ë“œ ì¶”ê°€
- [ ] `managers` í…Œì´ë¸” í™•ì¥ ë˜ëŠ” `department_approvers` í…Œì´ë¸” ìƒì„±

### Phase 3: API í•¨ìˆ˜ ìˆ˜ì •
- [ ] `approveByManager` í•¨ìˆ˜ êµ¬í˜„
- [ ] `approveByDepartmentApprover` í•¨ìˆ˜ êµ¬í˜„
- [ ] ê¸°ì¡´ `approveVisitRequest` í•¨ìˆ˜ëŠ” ìµœì¢… ìŠ¹ì¸ìš©ìœ¼ë¡œ ë³€ê²½

### Phase 4: UI ìˆ˜ì •
- [ ] EmployeeDashboardì— ì—­í• ë³„ íƒ­ ì¶”ê°€
- [ ] AdminApproval í˜ì´ì§€ì— ì—­í• ë³„ ìŠ¹ì¸ ë²„íŠ¼ í‘œì‹œ
- [ ] ìŠ¹ì¸ ë‹¨ê³„ í‘œì‹œ (í˜„ì¬ ë‹¨ê³„ í•˜ì´ë¼ì´íŠ¸)

### Phase 5: ë¡œê·¸ì¸ ë° ê¶Œí•œ ê´€ë¦¬
- [ ] ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„
- [ ] ì‚¬ìš©ì ì—­í•  í™•ì¸ í•¨ìˆ˜ êµ¬í˜„
- [ ] ë¼ìš°íŠ¸ ë³´í˜¸ (Protected Route)

## ğŸ” ê¶Œí•œ ê´€ë¦¬

### ì—­í•  ì •ì˜
- **manager**: ë‹´ë‹¹ì (1ë‹¨ê³„ ìŠ¹ì¸ ê¶Œí•œ)
- **department_approver**: ë¶€ì„œ ìŠ¹ì¸ì (2ë‹¨ê³„ ìŠ¹ì¸ ê¶Œí•œ, QR ìƒì„± + SMS ë°œì†¡)
- **admin**: ê´€ë¦¬ì (ëª¨ë“  ê¶Œí•œ)

### ê¶Œí•œ í™•ì¸ í•¨ìˆ˜

```typescript
// src/lib/auth.ts
export async function getUserRole(userId: string): Promise<string | null> {
  const { data, error } = await supabase
    .from("user_roles")
    .select("role")
    .eq("user_id", userId)
    .single();

  if (error) return null;
  return data?.role || null;
}

export async function isManager(userId: string): Promise<boolean> {
  const role = await getUserRole(userId);
  return role === 'manager' || role === 'admin';
}

export async function isDepartmentApprover(userId: string): Promise<boolean> {
  const role = await getUserRole(userId);
  return role === 'department_approver' || role === 'admin';
}
```

## ğŸ“Œ ì°¸ê³ ì‚¬í•­

1. **ë‹´ë‹¹ì ë° ìŠ¹ì¸ì ì •ë³´ ì—…ë°ì´íŠ¸**
   - DB ì—°ë™ ë˜ëŠ” ìˆ˜ë™ìœ¼ë¡œ `managers` í…Œì´ë¸”ì— ì •ë³´ ì…ë ¥
   - ë°©ë¬¸ ì‹ ì²­ ì‹œ `manager_id`, `visiting_department`, `department_approver_id` ìë™ ì„¤ì •

2. **QR ì½”ë“œ ìƒì„± ì‹œì **
   - í˜„ì¬: ë‹¨ì¼ ìŠ¹ì¸ ì‹œ ìƒì„±
   - ë³€ê²½: ë¶€ì„œ ìŠ¹ì¸ì ìŠ¹ì¸ ì‹œ ìƒì„± (ìµœì¢… ìŠ¹ì¸)

3. **SMS ë°œì†¡ ì‹œì **
   - í˜„ì¬: ë‹¨ì¼ ìŠ¹ì¸ ì‹œ ë°œì†¡
   - ë³€ê²½: ë¶€ì„œ ìŠ¹ì¸ì ìŠ¹ì¸ ì‹œ ë°œì†¡ (QR ì½”ë“œ ë§í¬ í¬í•¨)

4. **í•˜ìœ„ í˜¸í™˜ì„±**
   - ê¸°ì¡´ ë‹¨ì¼ ìŠ¹ì¸ í”„ë¡œì„¸ìŠ¤ì™€ì˜ í˜¸í™˜ì„± ìœ ì§€
   - ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ê³„

